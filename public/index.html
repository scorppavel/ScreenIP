<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —É—á—ë—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>üì∫ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —É—á—ë—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h1>

    <div class="form-group">
      <label>–ö–∞–±–∏–Ω–µ—Ç: <input type="text" id="room" placeholder="101"></label>
    </div>
    <div class="form-group">
      <label>–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞ IP (1‚Äì254): 
        <input type="number" id="lastOctet" min="1" max="254" placeholder="50">
      </label>
      <div id="error" class="error"></div>
    </div>
    <button onclick="addDevice()">–î–æ–±–∞–≤–∏—Ç—å</button>

    <h2>–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
    <table id="deviceTable">
      <thead>
        <tr><th>–ö–∞–±–∏–Ω–µ—Ç</th><th>IP-–∞–¥—Ä–µ—Å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
      </thead>
      <tbody id="deviceList"></tbody>
    </table>
  </div>

  <script>
    async function loadDevices() {
      try {
        const res = await fetch('/api/devices');
        const devices = await res.json();
        const tbody = document.getElementById('deviceList');
        if (devices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
          return;
        }
        tbody.innerHTML = devices.map(d => `
          <tr>
            <td>${d.room}</td>
            <td>${d.ip}</td>
            <td><button class="delete-btn" onclick="deleteDevice(${d.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
          </tr>
        `).join('');
      } catch (e) {
        console.error(e);
        document.getElementById('deviceList').innerHTML = '<tr><td colspan="3" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
      }
    }

    async function addDevice() {
      const room = document.getElementById('room').value.trim();
      const lastOctet = document.getElementById('lastOctet').value.trim();
      const err = document.getElementById('error');
      err.textContent = '';

      if (!room || !lastOctet) {
        err.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
      }

      const num = +lastOctet;
      if (num < 1 || num > 254 || !Number.isInteger(num)) {
        err.textContent = '–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞: 1‚Äì254';
        return;
      }

      try {
        const res = await fetch('/api/devices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ room, lastOctet })
        });
        const result = await res.json();
        if (res.ok) {
          document.getElementById('room').value = '';
          document.getElementById('lastOctet').value = '';
          loadDevices();
        } else {
          err.textContent = result.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
        }
      } catch (e) {
        err.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
      }
    }

    async function deleteDevice(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?')) return;
      try {
        const res = await fetch(`/api/devices/${id}`, { method: 'DELETE' });
        if (res.ok) loadDevices();
        else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      } catch (e) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadDevices();
  </script>
</body>
</html>